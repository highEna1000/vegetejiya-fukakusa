{% extends "base.html" %}

{% block title %}仕事リスト管理{% endblock %}

{% block content %}
  <div class="tasks-layout">
    <!-- 仕事一覧セクション -->
    <div class="tasks-section">
      <h2>仕事リスト一覧</h2>
      
      <!-- モバイル用カード表示 -->
      <div class="mobile-task-cards" id="mobile-task-list">
        {% for task in tasks %}
        <div class="task-card" data-task-id="{{ task.id }}">
          <div class="task-header">
            <div class="drag-handle">⋮⋮</div>
            <div class="task-info">
              <h3>{{ task.name }}</h3>
            </div>
          </div>
          <div class="task-actions">
            <a href="{{ url_for('manage_tasks', task_id=task.id) }}" class="btn btn-small">編集</a>
            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" 
                  onsubmit="return confirm('この仕事を削除すると、全ユーザーの関連スキルデータも削除されます。本当によろしいですか？');" 
                  style="display: inline;">
              <input type="submit" value="削除" class="btn btn-danger btn-small">
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- デスクトップ用テーブル表示 -->
      <div class="desktop-task-table">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>現在の仕事内容</th>
                <th colspan="3">操作</th>
              </tr>
            </thead>
            <tbody id="desktop-task-list">
              {% for task in tasks %}
              <tr data-task-id="{{ task.id }}">
                <td style="text-align: left; padding-left: 10px;">{{ task.name }}</td>
                <td style="width: 60px;">
                  <button onclick="moveTask({{ task.id }}, 'up')" class="btn btn-small" {% if loop.first %}disabled{% endif %}>↑</button>
                </td>
                <td style="width: 60px;">
                  <button onclick="moveTask({{ task.id }}, 'down')" class="btn btn-small" {% if loop.last %}disabled{% endif %}>↓</button>
                </td>
                <td style="width: 80px;">
                  <a href="{{ url_for('manage_tasks', task_id=task.id) }}" class="btn btn-small">編集</a>
                </td>
                <td style="width: 80px;">
                  <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" onsubmit="return confirm('この仕事を削除すると、全ユーザーの関連スキルデータも削除されます。本当によろしいですか？');">
                    <input type="submit" value="削除" class="btn btn-danger btn-small">
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 仕事追加・編集セクション -->
    <div class="add-task-section">
      {% if form.name.data %}
        <h2>仕事を編集</h2>
      {% else %}
        <h2>新しい仕事を追加</h2>
      {% endif %}
      
      <form method="POST" class="add-task-form">
        {{ form.hidden_tag() }}
        <div class="form-group">
          {{ form.name.label }}
          {{ form.name() }}
        </div>
        {{ form.submit(class="btn btn-custom-primary-small") }}
      </form>
    </div>
  </div>

  <style>
    .tasks-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 2em;
      align-items: start;
    }
    
    .tasks-section h2,
    .add-task-section h2 {
      margin-top: 0;
      margin-bottom: 1em;
    }
    
    /* モバイル用タスクカード */
    .mobile-task-cards {
      display: none;
    }
    
    .task-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1em;
      margin-bottom: 1em;
      border-left: 4px solid #4a69bd;
      cursor: move;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .task-card.dragging {
      transform: rotate(5deg);
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    
    .task-header {
      display: flex;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    
    .drag-handle {
      color: #6c757d;
      font-size: 1.2em;
      cursor: grab;
      user-select: none;
      padding: 0.2em;
    }
    
    .drag-handle:active {
      cursor: grabbing;
    }
    
    .task-info h3 {
      margin: 0 0 1em 0;
      color: #4a69bd;
      font-size: 1.1em;
    }
    
    .task-actions {
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
    }
    
    .desktop-task-table {
      display: block;
    }
    
    /* フォームスタイル */
    .add-task-form {
      background: #f8f9fa;
      padding: 1.5em;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    /* モバイル対応 */
    @media (max-width: 1024px) {
      .tasks-layout {
        grid-template-columns: 1fr;
        gap: 2em;
      }
    }
    
    @media (max-width: 768px) {
      .mobile-task-cards {
        display: block;
      }
      
      .desktop-task-table {
        display: none;
      }
      
      .add-task-form {
        padding: 1em;
      }
      
      .btn-custom-primary-small {
        width: 100% !important;
        padding: 10px 16px !important;
      }
      
      .task-actions {
        justify-content: center;
      }
    }
    
    /* 管理者用ボタンサイズ統一 */
    .btn-custom-primary-small {
      background-color: #4a69bd !important;
      border-color: #4a69bd !important;
      color: white !important;
      padding: 8px 16px !important;
      font-size: 14px !important;
      border-radius: 4px !important;
      text-decoration: none !important;
      border: 1px solid !important;
      cursor: pointer !important;
      min-height: auto !important;
    }
    
    .btn-custom-primary-small:hover {
      background-color: #3c5aa6 !important;
      border-color: #3c5aa6 !important;
    }
    
    @media (max-width: 480px) {
      .task-card {
        padding: 0.8em;
      }
      
      .task-actions {
        flex-direction: column;
      }
      
      .task-actions .btn {
        width: 100%;
        margin-bottom: 0.3em;
        padding: 8px 12px;
        font-size: 13px;
      }
      
      .btn-custom-primary-small {
        width: 100% !important;
        padding: 10px 16px !important;
      }
    }
  </style>
  
  <script>
    // デスクトップ用順序変更
    function moveTask(taskId, direction) {
      const taskList = Array.from(document.querySelectorAll('#desktop-task-list tr[data-task-id]'));
      const currentIndex = taskList.findIndex(row => row.dataset.taskId == taskId);
      
      let newIndex;
      if (direction === 'up' && currentIndex > 0) {
        newIndex = currentIndex - 1;
      } else if (direction === 'down' && currentIndex < taskList.length - 1) {
        newIndex = currentIndex + 1;
      } else {
        return;
      }
      
      // DOMでの順序変更
      const currentRow = taskList[currentIndex];
      const targetRow = taskList[newIndex];
      
      if (direction === 'up') {
        targetRow.parentNode.insertBefore(currentRow, targetRow);
      } else {
        targetRow.parentNode.insertBefore(currentRow, targetRow.nextSibling);
      }
      
      // サーバーに順序を送信
      const newTaskIds = Array.from(document.querySelectorAll('#desktop-task-list tr[data-task-id]'))
        .map(row => parseInt(row.dataset.taskId));
      
      saveTaskOrder(newTaskIds);
    }
    
    // モバイル用ドラッグアンドドロップ
    let draggedElement = null;
    let placeholder = null;
    
    function initMobileDragAndDrop() {
      const taskCards = document.querySelectorAll('.task-card');
      
      taskCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragend', handleDragEnd);
        card.setAttribute('draggable', 'true');
      });
    }
    
    function handleDragStart(e) {
      draggedElement = this;
      this.classList.add('dragging');
      
      // プレースホルダーを作成
      placeholder = document.createElement('div');
      placeholder.className = 'task-card placeholder';
      placeholder.style.height = this.offsetHeight + 'px';
      placeholder.style.background = '#e9ecef';
      placeholder.style.border = '2px dashed #4a69bd';
      placeholder.innerHTML = '<div style="text-align: center; padding: 1em; color: #6c757d;">ここにドロップ</div>';
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      
      if (this === draggedElement) return;
      
      const container = this.parentNode;
      const afterElement = getDragAfterElement(container, e.clientY);
      
      if (afterElement == null) {
        container.appendChild(placeholder);
      } else {
        container.insertBefore(placeholder, afterElement);
      }
    }
    
    function handleDrop(e) {
      e.preventDefault();
      
      if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.insertBefore(draggedElement, placeholder);
        placeholder.remove();
        
        // 新しい順序をサーバーに送信
        const newTaskIds = Array.from(document.querySelectorAll('.task-card[data-task-id]'))
          .map(card => parseInt(card.dataset.taskId));
        
        saveTaskOrder(newTaskIds);
      }
    }
    
    function handleDragEnd(e) {
      this.classList.remove('dragging');
      
      if (placeholder && placeholder.parentNode) {
        placeholder.remove();
      }
      
      draggedElement = null;
      placeholder = null;
    }
    
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
      
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // サーバーに順序を保存
    function saveTaskOrder(taskIds) {
      fetch('/admin/reorder_tasks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task_ids: taskIds })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          console.error('順序の保存に失敗しました:', data.message);
        }
      })
      .catch(error => {
        console.error('エラー:', error);
      });
    }
    
    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      if (window.matchMedia('(max-width: 768px)').matches) {
        initMobileDragAndDrop();
      }
    });
  </script>
{% endblock %}